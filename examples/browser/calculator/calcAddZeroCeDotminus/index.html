<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <!-- prevent favicon request -->
    <link href="data:;base64,iVBORw0KGgo=" rel="icon" />
    <title>Calculator Addition Zero as Special case, Clear button</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
      <div class="content">
        <svg class="graph"><g></g></svg>
           <div class="calc">
            <p id="display" class="calc__display"></p>
            <div class="calc__keys">
             <button class="key"              id="seven">7</button>
             <button class="key"              id="eight">8</button>
             <button class="key"               id="nine">9</button>
             <button class="key"                        > </button>
             <button class="key"               id="four">4</button>
             <button class="key"               id="five">5</button>
             <button class="key"                id="six">6</button>
             <button class="key"                        > </button>            
             <button class="key key--add"       id="add">+</button>
             <button class="key"                id="one">1</button>
             <button class="key"                id="two">2</button>
             <button class="key"              id="three">3</button>
             <button class="key"              id="minus">-</button>
             <button class="key"               id="zero">0</button>
             <button class="key"                id="dot">.</button>
             <button class="key key--equals" id="equals">=</button>
             <button class="key"              id="ce"  >ce</button>
            </div>
          </div>
          <div class="extendedState">
            <table>
            <tr>
              <th>State: </th>
              <td id="table__state"></td>
            </tr>
            <tr>
              <th>data: </th>
              <td id="table__data"></td>
            </tr>
            <tr>
              <th>opnd1: </th>
              <td id="table__opnd1"></td>
            </tr>
            <tr>
              <th>operator: </th>
              <td id="table__operator"></td>
            </tr>
            <tr>
              <th>opnd2:</th>
              <td id="table__opnd2"></td>
            </tr>
           </table>
          </div>
      </div>
    </div>

  <script src="../../../../statecharts/libraries/xstate.js"></script> 
  <script src="../../../../statecharts/libraries/d3.v5.min.js"></script>
  <script src="../../../../statecharts/libraries/dagre-d3.min.js"></script>
  <script src="../../../../statecharts/parser/grammarXstate.js"></script>
  <script src="../../../../statecharts/parser/grammarDagreD3.js"></script>
  <script src="../../../../statecharts/libraries/utils.js"></script>


  <script>

/**
 *     
 *                      SETUP
 *  
 *
 **/

   const { Machine,  interpret, assign } = XState; 
   const ParserXstate                    = grammarXstate.Parser;
   const parserXstate                    = new ParserXstate(grammarXstate);
   const createMachineConf               = input => parserXstate.parse(input);
   const ParserDagredD3                  = grammarDagreD3.Parser;
   const parserDagredD3                  = new ParserDagredD3(grammarDagreD3);

   const calcDisplay                     = document.getElementById("display");
   const seven                           = document.getElementById("seven");
   const eight                           = document.getElementById("eight");
   const nine                            = document.getElementById("nine");
   const add                             = document.getElementById("add" );
   const four                            = document.getElementById("four");
   const five                            = document.getElementById("five");
   const six                             = document.getElementById("six" );
   const one                             = document.getElementById("one");
   const two                             = document.getElementById("two");
   const three                           = document.getElementById("three");
   const minus                           = document.getElementById("minus");
   const zero                            = document.getElementById("zero");
   const equals                          = document.getElementById("equals");
   const dot                             = document.getElementById("dot");
   const ce                              = document.getElementById("ce");

   const tableState                      = document.getElementById("table__state");
   const tableData                       = document.getElementById("table__data");
   const tableOpnd1                      = document.getElementById("table__opnd1");
   const tableOperator                   = document.getElementById("table__operator");
   const tableOpnd2                      = document.getElementById("table__opnd2");


/**
 *     
 *                                   FINITE STATE  MACHINE
 *  
 *
 **/

function calculate(ctx) {
  let opnd1    = ctx.opnd1.join("");
  let operator = ctx.operator.join("");
  let opnd2    = ctx.opnd2.join("");

  switch (operator) {
    case "+":
      return [(+opnd1 + +opnd2)];
    default:
      return "error";
  }
}


  
  const options = {
    actions: {
      setdata:          assign({data:     (ctx,evt) => ctx.data.concat(evt.payload)}),
      setopnd1:         assign({opnd1:    (ctx,evt) => ctx.opnd1.concat(evt.payload)}),
      setdataempt:      assign({data:     (ctx,evt) => []}),
      setopnd1empt:     assign({opnd1:    (ctx,evt) => []}),
      setoperator:      assign({operator: (ctx,evt) => ctx.operator.concat(evt.payload)}),
      setopnd2:         assign({opnd2:    (ctx,evt) => ctx.opnd2.concat(evt.payload)}),
      setoperatorempt:  assign({operator: (ctx,evt) => []}),
      setopnd2empt:     assign({opnd2:    (ctx,evt) => []}),
      calculate:        assign({data:     (ctx,evt) => calculate(ctx)}),
      displaydata:      (ctx) => calcDisplay.textContent = ctx.data.join(""), 
    },
     services: {}
   };


/**
 *   https://xstate.js.org/docs/guides/actions.html#action-order
 *  
 *   "The order of actions should not necessarily matter ... However,  
 *    the order of actions in the state.actions array is:  
 *    1 exit actions - 2 transition - 3 entry actions"
 * 
 */
   const stateTransitionTable =
`
context:
      data: []
     opnd1: []
  operator: []
     opnd2: []

 *START           number       OPND1         :setdata         :setopnd1       exit: displaydata
  START           zero         OPND1ZERO     :setdata         :setopnd1       exit: displaydata
  START           minus        OPND1MINUS    :setdata         :setopnd1       exit: displaydata


  OPND1           number       OPND1         :setdata         :setopnd1       exit: displaydata
  OPND1           operator     OPRTRENTERED  :setdata         :setoperator    exit: displaydata
  OPND1           zero         OPND1         :setdata         :setopnd1       exit: displaydata
  OPND1           dot          OPND1DOT      :setdata         :setopnd1       exit: displaydata



  OPND1MINUS      zero         OPND1ZERO     :setdata         :setopnd1       exit: displaydata
  OPND1MINUS      number       OPND1         :setdata         :setopnd1       exit: displaydata

  OPND1DOT        number       OPND1DOT      :setdata         :setopnd1       exit: displaydata
  OPND1DOT        zero         OPND1DOT      :setdata         :setopnd1       exit: displaydata
  OPND1DOT        operator     OPRTRENTERED  :setdata         :setoperator    exit: displaydata
  


  OPND1ZERO       dot          OPND1DOT      :setdata         :setopnd1       exit: displaydata

  OPRTRENTERED    number       OPND2         :setdata         :setopnd2       exit: displaydata 
  OPRTRENTERED    zero         OPND2ZERO     :setdata         :setopnd2       exit: displaydata 
  OPRTRENTERED    minus        OPND2MINUS    :setdata         :setopnd2       exit: displaydata
  

  OPND2MINUS      zero         OPND2ZERO     :setdata         :setopnd2       exit: displaydata
  OPND2MINUS      number       OPND2         :setdata         :setopnd2       exit: displaydata

  OPND2ZERO       dot          OPND2DOT      :setdata         :setopnd2       exit: displaydata

  OPND2           number       OPND2         :setdata         :setopnd2       exit: displaydata
  OPND2           zero         OPND2         :setdata         :setopnd2       exit: displaydata
  OPND2           equals       RESULT        :calculate       :displaydata
  OPND2           dot          OPND2DOT      :setdata         :setopnd2       exit: displaydata

  OPND2DOT        number       OPND2DOT      :setdata         :setopnd2       exit: displaydata
  OPND2DOT        zero         OPND2DOT      :setdata         :setopnd2       exit: displaydata
  OPND2DOT        operator     OPRTRENTERED  :setdata         :setoperator    exit: displaydata
  OPND2DOT        equals       RESULT        :calculate       :displaydata


  RESULT          ce           START         :setdataempt     :setopnd1empt  
                                             :setoperatorempt :setopnd2empt   exit: displaydata
`;




   const calcMachineConf      = createMachineConf(stateTransitionTable); 

   const calcMachine          = Machine(calcMachineConf,options);

   const calcMachineService   = interpret(calcMachine)
        .onTransition(state => {
          tableState.textContent    = state.value;
          tableData.textContent     = state.context.data
          tableOpnd1.textContent    = state.context.opnd1
          tableOperator.textContent = state.context.operator
          tableOpnd2.textContent    = state.context.opnd2
          showFn(state);
        }
    );

/**
 *                                  EVENTS
 *
 **/
   seven.addEventListener('click', () => calcMachineService.send({type: "number",   payload: 7  }));
   eight.addEventListener('click', () => calcMachineService.send({type: "number",   payload: 8  }));
   nine.addEventListener('click',  () => calcMachineService.send({type: "number",   payload: 9  }));
   add.addEventListener('click',   () => calcMachineService.send({type: "operator", payload:"+" }));
   four.addEventListener('click',  () => calcMachineService.send({type: "number",   payload: 4  }));
   five.addEventListener('click',  () => calcMachineService.send({type: "number",   payload: 5  }));
   six.addEventListener('click',   () => calcMachineService.send({type: "number",   payload: 6  }));
   one.addEventListener('click',   () => calcMachineService.send({type: "number",   payload: 1  }));
   two.addEventListener('click',   () => calcMachineService.send({type: "number",   payload: 2  }));
   three.addEventListener('click', () => calcMachineService.send({type: "number",   payload: 3  }));
   minus.addEventListener('click', () => calcMachineService.send({type: "minus",   payload:"-" }));
   zero.addEventListener('click',  () => calcMachineService.send({type: "zero",     payload: 0  }));
   equals.addEventListener('click',() => calcMachineService.send({type: "equals",   payload: "="}));
   dot.addEventListener('click',   () => calcMachineService.send({type: "dot",      payload: "."}));
   ce.addEventListener('click',    () => calcMachineService.send({type: "ce",                   }));

/**
 *     
 *                                  GRAPH
 *  
 *
 **/

   var g = new dagreD3.graphlib.Graph({multigraph: true}).setGraph({rankdir: 'LR'});

   let arr = parserDagredD3.parse(stateTransitionTable); 

   graphSetStatesEdges(arr); 

   var svg = d3.select("svg"), inner = svg.select("g");
   
   // Set up zoom support
   var zoom = d3.zoom().on("zoom", function() {
         inner.attr("transform", d3.event.transform);
       });

   svg.call(zoom);
   
   // Create the renderer
   var render = new dagreD3.render();
   
   // Run the renderer. This is what draws the final graph.
   render(inner, g);
   
    // Center the graph
   var initialScale = 0.98;
   svg.call(
     zoom.transform,
     d3.zoomIdentity.translate((svg.attr("width") - g.graph().width * initialScale) / 100, 50).scale(initialScale));


   
   svg.attr('height', g.graph().height * initialScale + 40);



/**
  *                                TESTS
  */


  function testRunner(test) {
     for(let j = 0; j < test.length; j++) {
            setTimeout(function() {
            calcMachineService.send(test[j]);
           }, j * 1500, j) 
     }
   } 


   
  const input = { 
    seven:{type: "number",   payload: 7  },
    eight:{type: "number",   payload: 8  },
    nine :{type: "number",   payload: 9  },
    add  :{type: "operator", payload:"+" },
    four :{type: "number",   payload: 4  },
    five :{type: "number",   payload: 5  },
    six  :{type: "number",   payload: 6  },
    one  :{type: "number",   payload: 1  },
    two  :{type: "number",   payload: 2  },
    three:{type: "number",   payload: 3  },
    minus:{type: "minus",    payload:"-" },
    zero :{type: "zero",     payload: 0  },
    equals:{type: "equals",   payload: "="},
    dot  :{type: "dot",      payload: "."},
    ce   :{type: "ce",                   }
  };
   
// -1+1= ce 
   const test1 = 
    [input.minus, input.one, input.add, input.one, input.equals, input.ce];

// -12+1= ce 
   const test2 = 
    [input.minus, input.one, input.two,input.add, input.one, input.equals, input.ce];
   
// 1+-1= ce
   const test3 = 
    [ input.minus, input.one, input.add, input.minus, input.one, input.equals, input.ce];

// 1+-12= ce
   const test4 = 
    [ input.one, input.add, input.minus, input.one, input.two, input.equals, input.ce];

//  1+1= ce   
   const test5 =
     [input.one, input.add, input.one,  input.equals, input.ce];

// 1+12= ce
   const test6 = 
    [input.one, input.add, input.one, input.two, input.equals, input.ce];

   
//   testRunner(test1);   // -1+1= ce 

//   testRunner(test2);   // -12+1= ce  

//   testRunner(test3);   // -1+-1= ce

//   testRunner(test4);  //  1+-12= ce

//   testRunner(test5);  //  1+1= ce   

//   testRunner(test6);   //  1+12= ce

 

   

/**
 *     
 *      MAIN 
 *  
 **/

 calcMachineService.start();

  
  </script>
</body>
</html>



