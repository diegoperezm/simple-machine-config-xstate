<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <!-- prevent favicon request -->
    <link href="data:;base64,iVBORw0KGgo=" rel="icon" />
    <title>Traffic Lights</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
	<div class="container">
      <div class="content">
          <svg class="graph" width="1024" height="600"><g/></svg>
      </div>
	</div>

  <script src="../../../../statecharts/libraries/xstate.js"></script>
  <script src="../../../../statecharts/libraries/d3.v5.min.js"></script>
  <script src="../../../../statecharts/libraries/dagre-d3.min.js"></script>
  <script src="../../../../statecharts/parser/grammarXstate.js"></script>
  <script src="../../../../statecharts/parser/grammarDagreD3.js"></script>
  <script src="../../../../statecharts/libraries/utils.js"></script>
 
  <script>

/**
 *     
 *                      SETUP
 *  
 *
 **/

   const { Machine,  interpret, assign  } = XState; 
   const createMachineConf                = input => parserXstate.parse(input);
   const ParserXstate                     = grammarXstate.Parser;
   const parserXstate                     = new ParserXstate(grammarXstate);
   const ParserDagredD3                   = grammarDagreD3.Parser;
   const parserDagredD3                   = new ParserDagredD3(grammarDagreD3);
   const prevEdges                        = [];   

/**
 *     
 *                      STATECHARTS
 *  
 *
 **/

   const stateTransitionTable = 
   `
    *GREEN   time YELLOW :printgreen
     YELLOW  time RED    :prinyellow
     RED     time GREEN  :printred

  `;

   const printGreen           = () => console.log('=> green');
   const printYellow          = () => console.log('=> yellow');
   const printRed             = () => console.log('=> red');


	 
// xstate expects an object
   const trafficlightsActions = {
	actions: {
        	printgreen  : printGreen,
		printyellow : printYellow,
		printred    : printRed
		}
    };

// Create a machine conf for xstate
   const trafficlightsMachineConf   = createMachineConf(stateTransitionTable);

// Pass the machine conf to xstate
   const trafficlightsMachine       = Machine(trafficlightsMachineConf,trafficlightsActions);


/**
 * Using xstate's interpreter to run the statecharts.
 * An interpreted, running instance of a statecharts is called a service (xstate docs).
 */
  const trafficlightsService       = interpret(trafficlightsMachine)
    .onTransition(state => highlightCurrentPath(state,prevEdges)
  );

// This will be printed (console)
 //  const trafficlightsMachineConfStr = JSON.stringify(trafficlightsMachineConf,null,2);
// console.log('\n- Machine conf for xstate:\n\n', trafficlightsMachineConfStr,'\n\nOutput\n\n');
																					 

/**
 *     
 *      GRAPH
 *  
 *
 **/
	 
   var g = new dagreD3.graphlib.Graph({multigraph: true}).setGraph({rankdir: 'LR'});

   let arr = parserDagredD3.parse(stateTransitionTable); 

   graphSetStatesEdges(arr); 

   var svg = d3.select("svg"), inner = svg.select("g");
   
   // Set up zoom support
   var zoom = d3.zoom().on("zoom", function() {
         inner.attr("transform", d3.event.transform);
       });
   svg.call(zoom);
   
   // Create the renderer
   var render = new dagreD3.render();
   
   // Run the renderer. This is what draws the final graph.
   render(inner, g);
   
   // Center the graph
   //var initialScale = 0.75;
   var initialScale = 1;
   svg.call(zoom.transform, d3.zoomIdentity.translate((svg.attr("width") - g.graph().width * initialScale) / 2, 20).scale(initialScale));
   
   svg.attr('height', g.graph().height * initialScale + 40);


      trafficlightsService.start();
//      trafficlightsService.send("time");
    //  trafficlightsService.send("time");
    //  trafficlightsService.send("time");


   </script>
</body>
</html>



