<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <!-- prevent favicon request -->
    <link href="data:;base64,iVBORw0KGgo=" rel="icon" />
    <title>Traffic Lights</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
      <div class="content">
         <svg width="50%"  class="graph"><g transform="translate(100,100)"/></svg>
           <div class="trafficlights">
              <div id="green"   class="light"></div>
              <div id="yellow" class="light"></div>
              <div id="red"     class="light"></div>
           </div>
       </div>
     </div>

  <script src="js/xstate.js"></script> 
  <script src="js/d3.v5.min.js"></script>
  <script src="js/dagre-d3.min.js"></script>
  <script src="js/grammarXstate.js"></script>
  <script src="js/grammarDagreD3.js"></script>
  <script src="js/utils.js"></script>
  <script>

/**
 *     
 *                      SETUP
 *  
 *
 **/

   const { Machine,  interpret, assign } = XState; 
   const createMachineConf               = input => parserXstate.parse(input);
   const ParserXstate                    = grammarXstate.Parser;
   const parserXstate                    = new ParserXstate(grammarXstate);
   const ParserDagredD3                  = grammarDagreD3.Parser;
   const parserDagredD3                  = new ParserDagredD3(grammarDagreD3);
   const prevStateCurrState              = ['INITIAL'];
   const lightGreen                      = document.getElementById('green');
   const lightYellow                     = document.getElementById('yellow');
   const lightRed                        = document.getElementById('red');
  

/**
 *     
 *                      STATECHARTS
 *  
 *
 **/

   const stateTransitionTable = 
   `
    *GREEN  time YELLOW :setstyledomgreen
     YELLOW time RED    :setstyledomyellow 
     RED    time GREEN  :setstyledomred 
   `;


   const setStyleDomGreen = () => {
                                  lightGreen.setAttribute('class', 'light green');
                                  lightYellow.setAttribute('class', 'light');
                                  lightRed.setAttribute('class',    'light');
                                  };


   const setStyleDomYellow = () => {
                                   lightGreen.setAttribute('class', 'light ');
                                   lightYellow.setAttribute('class', 'light yellow');
                                   lightRed.setAttribute('class',    'light');
                                   }

   const setStyleDomRed    = () => {
                                   lightGreen.setAttribute('class', 'light');
                                   lightYellow.setAttribute('class', 'light');
                                   lightRed.setAttribute('class', 'light red');
                                   }


 
// xstate expects an object
   const trafficlightsActions = {
     actions: {
       setstyledomgreen   : setStyleDomGreen,
       setstyledomyellow  : setStyleDomYellow,
       setstyledomred     : setStyleDomRed
     }
  };

// Create a machine conf for xstate
   const trafficlightsMachineConf   = createMachineConf(stateTransitionTable);

// Pass the machine conf to xstate
   const trafficlightsMachine       = Machine(trafficlightsMachineConf,trafficlightsActions);
	 
/**
 *
 * Using xstate's interpreter to run the statecharts.
 * An interpreted, running instance of a statecharts is called a service (xstate docs).
 * 
 * https://xstate.js.org/docs/guides/interpretation.html#transitions  
 * Listeners for state transitions are registered via the .onTransition(...) method
 *
 */
    const trafficlightsService       = interpret(trafficlightsMachine)
 	                                        .onTransition( state => highlightCurrentPath(state,prevStateCurrState));


/**
 *     
 *      GRAPH
 *  
 *
 **/

   var g = new dagreD3.graphlib.Graph().setGraph({rankdir: 'TB'});

   let arr = parserDagredD3.parse(stateTransitionTable); 
   let states = arr[0];
   let edges  = arr[1];
	 
   states.forEach(function(state) {
       if(state === "FINAL" || state === "INITIAL"  ) {
         g.setNode(state, { label: "" }); 
         g.node(state).style = "fill: #333";
       } else {
         g.setNode(state, { label: state }); 
       }
   });

   edges.forEach( function(ele) { g.setEdge(ele[0], ele[1], { label: ele[2]}); });

   // Set some general styles
   g.nodes().forEach(function(v) {
     var node = g.node(v);
     node.rx = node.ry = 10;
   });

	 
   var svg = d3.select("svg"), inner = svg.select("g");
   
   // Set up zoom support
   var zoom = d3.zoom().on("zoom", function() {
         inner.attr("transform", d3.event.transform);
       });

   svg.call(zoom);
   
   // Create the renderer
   var render = new dagreD3.render();
   
   // Run the renderer. This is what draws the final graph.
   render(inner, g);
   
 
   var initialScale = 2;
	  svg.attr('height', g.graph().height * initialScale + 40);		

/**
 *     
 *      MAIN 
 *  
 *
 **/
    function trafficlightsRun() {
       trafficlightsService.start();
       setInterval(function() {
          trafficlightsService.send('time');
       }, 2000) 
    }

     trafficlightsRun();
  
   </script>
</body>
</html>



